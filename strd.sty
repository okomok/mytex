\ProvidesPackage{strd}

\usepackage{amsmath,mathtools,etoolbox,my}
\usepackage{tikz}
\usepackage[active,tightpage]{preview}
\usetikzlibrary{shapes,calc,decorations.markings,backgrounds}


% styles

% no transparent color?
\tikzset{strd celllabel/.style={font=\small,rounded rectangle,very thin,solid,rounded corners=0pt,rounded rectangle arc length=90,draw,fill=white,inner sep=1.2pt}}
\tikzset{strd linelabel/.style={font=\scriptsize,inner sep=0.2pt,strd textvaligned}}
\tikzset{strd doublelinelabel/.style={font=\tiny,inner sep=0.1pt,strd textvaligned}}
\tikzset{strd endlabel/.style={font=\small,inner sep=1pt,strd textvaligned}}
\tikzset{strd valigned/.style={baseline={([yshift=-0.5ex]current bounding box.center)}}}
\tikzset{strd textvaligned/.style={text height=1.5ex,text depth=0.25ex}}
\tikzset{strd coord/.style={coordinate}}
\tikzset{strd dot/.style={circle,draw=black,fill=black,minimum size=1.5pt,inner sep=0pt}}
\tikzset{strd mathnodes/.style={execute at begin node=$,execute at end node=$}}
\tikzset{strd none/.style={opacity=0,text opacity=0,fill opacity=0}}
\tikzset{strd picture/.style={strd mathnodes,very thin,rounded corners=2pt}}
\tikzset{strd draw/.style={}}
\tikzset{-<-/.style={decoration={markings,mark=at position .5 with {\arrow{<}}},postaction={decorate}}}
\tikzset{nomorepostaction/.code={\let\tikz@postactions\pgfutil@empty}}

% environmentals 

\newcommand{\strd}[1]{%
    \begin{tikzpicture}[strd picture]
        \strddeclorigin
        #1;
    \end{tikzpicture}%
}

\newcommand{\strdin}[2]{%
    \begin{#1}
        \!
        \strd{#2}
    \end{#1}%
}


% string constructors
%   A string 's' is a triple of nodes 's Start', 's' and 's End'.

\newcommand{\strdrange}[4]{%
    \node[strd coord] (#1 Start) at (#2) {};
    \node[strd coord] (#1) at (#3) {};
    \node[strd coord] (#1 End) at (#4) {};%
}

\newcommand{\strdcoordat}[3]{%
    \node[strd coord] (#3 Start) at (#1,#2) {};
    \node[strd coord] (#3) at (#1,#2) {};
    \node[strd coord] (#3 End) at (#1,#2) {};%
}

\newcommand{\strdcoord}[2]{%
    \node[strd coord] (#2 Start) at (#1) {};
    \node[strd coord] (#2) at (#1) {};
    \node[strd coord] (#2 End) at (#1) {};%
}

\newcommand{\strddeclorigin}{\strdcoordat{0}{0}{strdorigin}}
\newcommand{\strdorigin}{strdorigin}


% strings

% golden ratio
\newcommand{\strdxunit}{0.5}
\newcommand{\strdyunit}{0.8}
\newcommand{\strdhalfxunit}{0.25}
\newcommand{\strdhalfyunit}{0.4}
\newcommand{\strdunitdiff}{0.3}
\newcommand{\strdunitrest}{0.2}

\newcommand{\strdempty}[2]{%
    \node[strd coord] (#2) at (#1 End) {};
    \node[strd coord] (#2 Start) at (#2) {};
    \node[strd coord] (#2 End) at (#2) {};%
}

\newcommand{\strdhalfleft}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2) at ($(#1 End)+(-0.5,-0.3)$) {};
    \node[strd coord] (#2 End) at ($(#1 End)+(-0.5,-0.4)$) {};
    \draw[strd draw]{
        (#2 Start) parabola (#2) -- (#2 End)
    };%
}
\newcommand{\strdhalfright}[2]{\strdflip{\strdhalfleft{#1}{#2}}}

\newcommand{\strdhalfmid}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2 End) at ($(#1 End)+(0,-0.4)$) {};
    \draw[strd draw]{
        (#2 Start) -- (#2 End)
    };%
}

\newcommand{\strdhalfunleft}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2) at ($(#1 End)+(0,-0.1)$) {};
    \node[strd coord] (#2 End) at ($(#1 End)+(0.5,-0.4)$) {};
    \draw[strd draw]{
        (#2 Start) -- (#2) parabola[bend at end] (#2 End)
    };%
}
\newcommand{\strdhalfunright}[2]{\strdflip{\strdhalfunleft{#1}{#2}}}

\newcommand{\strdconnect}[3]{%
    \node[strd coord] (#3 Start) at (#1 Start) {};
    \node[strd coord] (#3) at (#2 Start) {};
    \node[strd coord] (#3 End) at (#2 End) {};%
}

\newcommand{\strdleft}[2]{%
    \strdhalfleft{#1}{#2 Top}
    \strdhalfmid{#2 Top}{#2 Bottom}
    \strdconnect{#2 Top}{#2 Bottom}{#2}%
}
\newcommand{\strdright}[2]{\strdflip{\strdleft{#1}{#2}}}

% removeme
\newcommand{\strdsplitleft}[2]{%
    \strdxscale{0.5}{\strdlshift{#1}{#2 Start}}
    \strdleft{#2 Start}{#2}%
}
\newcommand{\strdsplitright}[2]{\strdflip{\strdsplitleft{#1}{#2}}}

\newcommand{\strdunleft}[2]{%
    \strdhalfmid{#1}{#2 Top}
    \strdhalfunleft{#2 Top}{#2 Bottom}
    \strdconnect{#2 Top}{#2 Bottom}{#2}%
}
\newcommand{\strdunright}[2]{\strdflip{\strdunleft{#1}{#2}}}

\newcommand{\strdmid}[2]{%
    \strdhalfmid{#1}{#2 Top}
    \strdhalfmid{#2 Top}{#2 Bottom}
    \strdconnect{#2 Top}{#2 Bottom}{#2}
}

\newcommand{\strdlminus}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2) at ($(#1 End)+(-0.25,0)$) {};
    \node[strd coord] (#2 End) at ($(#1 End)+(-0.5,0)$) {};
    \draw[strd draw]{
        (#2 Start) -- (#2 End)
    };%
}
\newcommand{\strdrminus}[2]{\strdflip{\strdlminus{#1}{#2}}}

\newcommand{\strdminus}[2]{%
    \strdxscale{0.5}{
        \strdlminus{#1}{#2 Left}
        \strdempty{#1}{#2}
        \strdrminus{#1}{#2 Right}
    }
}

\newcommand{\strdsubset}[2]{%
    \strdhalfleft{#1}{#2 Top}
    \strdhalfunleft{#2 Top}{#2 Bottom}
    \strdconnect{#2 Top}{#2 Bottom}{#2}
}
\newcommand{\strdsupset}[2]{\strdflip{\strdsubset{#1}{#2}}}

\newcommand{\strdlbag}[2]{%
    \strdhalfright{#1}{#2 Top}
    \strdhalfunleft{#2 Top}{#2 Bottom}
    \strdconnect{#2 Top}{#2 Bottom}{#2}
}
\newcommand{\strdrbag}[2]{\strdflip{\strdlbag{#1}{#2}}}

\newcommand{\strdjump}[2]{\strdnone{\strdmid{#1}{#2}}}
\newcommand{\strdlshift}[2]{\strdnone{\strdlminus{#1}{#2}}}
\newcommand{\strdrshift}[2]{\strdnone{\strdrminus{#1}{#2}}}
\newcommand{\strddup}[2]{\strdnone{\strdminus{#1}{#2}}}


% square strings

% todo: strdhalfsqsubset?

\newcommand{\strdsqsubset}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2 StartCorner) at ($(#1 End)+(-\strdxunit,0)$) {};
    \node[strd coord] (#2) at ($(#1 End)+(-\strdxunit,-\strdhalfyunit)$) {};
    \node[strd coord] (#2 EndCorner) at ($(#1 End)+(-\strdxunit,-\strdyunit)$) {};
    \node[strd coord] (#2 End) at ($(#1 End)+(0,-\strdyunit)$) {};
    \draw[strd draw]{
        (#2 Start) -- (#2 StartCorner) -- (#2 EndCorner) -- (#2 End)
    };%
}
\newcommand{\strdsqsupset}[2]{\strdflip{\strdsqsubset{#1}{#2}}}

\newcommand{\strdsquare}[2]{%
    \strdsqsubset{#1}{#2 Left}
    \strdsqsupset{#1}{#2 Right}
    \strdjump{#1}{#2}%
}


% labels

\newcommand{\strddotlabel}[1]{%
    \node[strd dot] at (#1) {};%
}

% order matters; pgfonlayer would reset path styles.
\newcommand{\strdcelllabel}[2]{%
    \node[strd celllabel] at (#1) {#2};%
}

\newcommand{\strdsidelabel}[3]{%
    \node[strd linelabel,left] at (#1) {#2};
    \node[strd linelabel,right] at (#1) {#3};%
}

% can't apply everywhere
\newcommand{\strdlsbracket}{\raisebox{0.075em}{[}}
\newcommand{\strdrsbracket}{\raisebox{0.075em}{]}}

\newcommand{\strdihomlabel}[3]{%
    \node[strd linelabel,left] at (#1) {[#2};
    \node[strd linelabel,right] at (#1) {#3]};%
}

\newcommand{\strdstartlabel}[2]{%
    \node[strd endlabel,above] at (#1 Start) {#2};%
}

\newcommand{\strdendlabel}[2]{%
    \node[strd endlabel,below] at (#1 End) {#2};%
}


% transformations

\newcommand{\strdscope}[2]{%
    \begin{scope}[#1]
        #2
    \end{scope}%
}

\newcommand{\strdflip}[1]{\strdscope{xscale=-1}{#1}}
\newcommand{\strdreverse}[1]{\strdscope{yscale=-1}{#1}}
\newcommand{\strdxscale}[2]{\strdscope{xscale=#1}{#2}}
\newcommand{\strdyscale}[2]{\strdscope{yscale=#1}{#2}}
\newcommand{\strdscale}[3]{\strdscope{xscale=#1,yscale=#2}{#3}}
\newcommand{\strdnone}[1]{\strdscope{every path/.style=strd none,every node/.style=strd none}{#1}}
\newcommand{\strdnolabels}[1]{\strdscope{every node/.style=strd none}{#1}}
\newcommand{\strdpathis}[2]{\strdscope{every path/.style=#1}{#2}}
\newcommand{\strdnodeis}[2]{\strdscope{every node/.append style=#1}{#2}}


% category-theoric strings

\tikzset{strd bijection/.style={solid,thin,rounded corners=0pt}}
\tikzset{strd mapping/.style={rounded corners=2pt}}
\newcommand{\strdbijection}[2]{\strdpathis{strd bijection}{\strdsquare{#1}{#2}}}
\newcommand{\strdimplicit}[1]{\strdpathis{densely dotted}{#1}}


% category-theoric labels

\tikzset{strd bijlabel/.style={font=\small,rectangle,strd bijection,draw,fill=white,inner sep=1.2pt}}

\newcommand{\strdbijlabel}[2]{%
    \node[strd bijlabel] at (#1) {#2};%
}


% composed strings

\newcommand{\strdcap}[2]{%
    \strdleft{#1}{#2 Left}
    \strdright{#1}{#2 Right}
    \strdjump{#1}{#2}%
}

\newcommand{\strdcircle}[2]{%
    \strdsubset{#1}{#2 Left}
    \strdsupset{#1}{#2 Right}
    \strdjump{#1}{#2}%
}


% command combinators

% remove?
\newcommand{\strdlabeled}[5]{%
    \csuse{strd#1}{#2}{#4#5}
    \csuse{strd#3label}{#4#5}{#4}{#5}%
}

\newcommand{\strdfamily}[2]{%
    \left(#2\right)_{\!\!\!#1}%
}

\newcommand*{\strdmath}[1]{\scalebox{1.5}{\ensuremath{#1}}}


% double strings

\tikzset{strd doublecolor/.style={gray!35}}

% prefer background; other layers would reset surrounding styles...
\newcommand{\strdinbackground}[1]{%
    \begin{pgfonlayer}{background}
        #1 
    \end{pgfonlayer}%
}

\newcommand{\strddouble}[3]{%
    \strdinbackground{
        \strdscope{line width=2.84pt}{\csuse{strd#1}{#2}{#3}}
    }
    \strdscope{line width=2.44pt,shorten >= -0.2pt,shorten <= -0.2pt,strd doublecolor}{\csuse{strd#1}{#2}{#3 White}}%
}

\newcommand{\strddoublex}[3]{%
    \strdscope{line width=2.84pt}{\csuse{strd#1}{#2}{#3}}
    \strdscope{line width=2.44pt,shorten >= -0.2pt,shorten <= -0.2pt,strd doublecolor}{\csuse{strd#1}{#2}{#3 White}}%
}

\newcommand{\strddsidelabel}[3]{%
    \node[strd linelabel,left,xshift=-1pt] at (#1) {#2};
    \node[strd linelabel,right,xshift=1pt] at (#1) {#3};%
}

