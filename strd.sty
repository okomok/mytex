\ProvidesPackage{strd}

\usepackage{tikz,lambda,mathtools}
\usetikzlibrary{shapes,calc,decorations.markings,backgrounds,calc}


% For short names
%   \strduse{foo{x}} doesn't work... 
%   http://tex.stackexchange.com/questions/21466/test-if-token-is-a-control-sequence
\newcommand*{\strduse}[1]{%
    \ifcsdef{strd\detokenize{#1}}{\csuse{strd#1}}{#1}%
}


% Styles
%

\tikzset{strd normaltextvaligned/.style={text height=1.9ex,text depth=0.65ex}}
\tikzset{strd scripttextvaligned/.style={text height=1.5ex,text depth=0.4ex}}
%\tikzset{strd scripttextvaligned/.style={text height=1.5ex,text depth=0.25ex}}
\tikzset{strd coord/.style={coordinate}}
\tikzset{strd mathnodes/.style={execute at begin node=$,execute at end node=$}}
\tikzset{strd none/.style={opacity=0,text opacity=0,fill opacity=0}}
\tikzset{strd picturevaligned/.style={baseline={([yshift=-0.5ex]current bounding box.center)}}}
\tikzset{strd picture/.style={strd picturevaligned,strd mathnodes,very thin,rounded corners=2pt}}
\tikzset{strd draw/.style={}}
\tikzset{-<-/.style={decoration={markings,mark=at position .5 with {\arrow{<}}},postaction={decorate}}}


% Layers
%

\pgfdeclarelayer{strd gradedlayer}
\pgfdeclarelayer{strd pavelayer}
\pgfdeclarelayer{strd whitelayer}
\pgfdeclarelayer{strd nodelayer}
\pgfdeclarelayer{strd labellayer}
\pgfsetlayers{background,main,strd pavelayer,strd gradedlayer,strd whitelayer,strd nodelayer,strd labellayer}

% layers reset surrounding line styles, so we define...
\newcommand*{\strdresetlinewidth}{\pgfsetlinewidth{0.2pt}}

\newcommand*{\strdonlayer}[2]{%
    \begin{pgfonlayer}{#1}
        #2
    \end{pgfonlayer}
    \strdresetlinewidth
}


% Environmentals 
%

\newcommand*{\strd}[1]{%
    \begin{tikzpicture}[strd picture]
        \strddeclorigin
        #1;
    \end{tikzpicture}%
}

\def\strdin[#1]#2{%
    \Foldr{\strdinimpl}{#2}{\Listize[#1]}%
}
\newcommand*{\strdinimpl}[2]{%
    \begin{#1}
        \! % why needed?
        \strd{#2}
    \end{#1}%
}


% String constructors
%   A string 's' is a triple of nodes 's Start', 's' and 's End'.
%

\newcommand*{\strdrange}[4]{%
    \node[strd coord] (#4 Start) at (#1) {};
    \node[strd coord] (#4) at (#2) {};
    \node[strd coord] (#4 End) at (#3) {};%
}

\newcommand*{\strdcoord}[2]{%
    \node[strd coord] (#2 Start) at (#1) {};
    \node[strd coord] (#2) at (#1) {};
    \node[strd coord] (#2 End) at (#1) {};%
}

\newcommand*{\strddeclorigin}{\strdcoord{0,0}{strdorigin}}
\newcommand*{\strdorigin}{strdorigin}


% Strings
%

\newcommand*{\strdxunit}{0.5}
\newcommand*{\strdyunit}{0.8}
\newcommand*{\strdxhalfunit}{0.25}
\newcommand*{\strdyhalfunit}{0.4}
\newcommand*{\strdunitdiff}{0.3}
\newcommand*{\strdunitmergin}{0.1}

\newcommand*{\strdempty}[2]{%
    \node[strd coord] (#2) at (#1 End) {};
    \node[strd coord] (#2 Start) at (#2) {};
    \node[strd coord] (#2 End) at (#2) {};%
}

\newcommand*{\strdcopy}[2]{%
    \node[strd coord] (#2) at (#1) {};
    \node[strd coord] (#2 Start) at (#1 Start) {};
    \node[strd coord] (#2 End) at (#1 End) {};%
}

\newcommand*{\strdleft}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2 Corner) at ($(#1 End)+(-\strdxunit,-\strdunitdiff)$) {};
    \node[strd coord] (#2) at ($(#1 End)+(-\strdxunit,-\strdyhalfunit)$) {};
    \node[strd coord] (#2 End) at ($(#1 End)+(-\strdxunit,-\strdyunit)$) {};
    \draw[strd draw]{
        (#2 Start) parabola (#2 Corner) -- (#2 End)
    };%
}
\newcommand*{\strdright}{\strdflip{\strdleft}}

\newcommand*{\strdmid}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2) at ($(#1 End)+(0,-\strdyhalfunit)$) {};
    \node[strd coord] (#2 End) at ($(#1 End)+(0,-\strdyunit)$) {};
    \draw[strd draw]{
        (#2 Start) -- (#2 End)
    };%
}

\newcommand*{\strdmidex}[2]{%
    \strdmid{#1}{#2}
    \strdyhalf{\strdmid}{#2}{#2 Ex}%
}

\newcommand*{\strdunleft}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2) at ($(#1 End)+(0,-\strdyhalfunit)$) {};
    \node[strd coord] (#2 Corner) at ($(#1 End)+(0,-\strdxunit)$) {};
    \node[strd coord] (#2 End) at ($(#1 End)+(\strdxunit,-\strdyunit)$) {};
    \draw[strd draw]{
        (#2 Start) -- (#2 Corner) parabola[bend at end] (#2 End)
    };%
}
\newcommand*{\strdunright}{\strdflip{\strdunleft}}

\newcommand*{\strdconnect}[3]{%
    \node[strd coord] (#3 Start) at (#1 Start) {};
    \node[strd coord] (#3) at (#2 Start) {};
    \node[strd coord] (#3 End) at (#2 End) {};%
}

\newcommand*{\strdhleft}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2) at ($(#1 End)+(-\strdxhalfunit,0)$) {};
    \node[strd coord] (#2 End) at ($(#1 End)+(-\strdxunit,0)$) {};
    \draw[strd draw]{
        (#2 Start) -- (#2 End)
    };%
}
\newcommand*{\strdhright}{\strdflip{\strdhleft}}

\newcommand*{\strdminus}[2]{%
    \strdscopexscale{0.5}{
        \strdhleft{#1}{#2 Left}
        \strdempty{#1}{#2}
        \strdhright{#1}{#2 Right}
    }
}

\newcommand*{\strdsubset}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2 StartCorner) at ($(#1 End)+(-\strdxunit,-\strdunitdiff)$) {};
    \node[strd coord] (#2) at ($(#1 End)+(-\strdxunit,-\strdyhalfunit)$) {};
    \node[strd coord] (#2 EndCorner) at ($(#1 End)+(-\strdxunit,-\strdxunit)$) {};
    \node[strd coord] (#2 End) at ($(#1 End)+(0,-\strdyunit)$) {};
    \draw[strd draw]{
        (#2 Start) parabola (#2 StartCorner) -- (#2 EndCorner) parabola[bend at end] (#2 End)
    };%
}
\newcommand*{\strdsupset}{\strdflip{\strdsubset}}

\newcommand*{\strdlint}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2 StartCorner) at ($(#1 End)+(-\strdxunit,-\strdunitdiff)$) {};
    \node[strd coord] (#2) at ($(#1 End)+(-\strdxunit,-\strdyhalfunit)$) {};
    \node[strd coord] (#2 EndCorner) at ($(#1 End)+(-\strdxunit,-\strdxunit)$) {};
    \node[strd coord] (#2 End) at ($(#1 End)+(-1,-\strdyunit)$) {};
    \draw[strd draw]{
        (#2 Start) parabola (#2 StartCorner) -- (#2 EndCorner) parabola[bend at end] (#2 End)
    };%
}
\newcommand*{\strdrint}{\strdflip{\strdlint}}

\newcommand*{\strdlchange}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2 StartCorner) at ($(#1 End)+(0,-\strdunitmergin)$) {};
    \node[strd coord] (#2) at ($(#1 End)+(-\strdxunit,-\strdyhalfunit)$) {};
    \node[strd coord] (#2 EndCorner) at ($(#2)+(-\strdxunit,-\strdunitdiff)$) {};
    \node[strd coord] (#2 End) at ($(#2)+(-\strdxunit,-\strdyhalfunit)$) {};
    \draw[strd draw]{
        (#2 Start) -- (#2 StartCorner) parabola[bend at end] (#2) parabola (#2 EndCorner) -- (#2 End)
    };%
}
\newcommand*{\strdrchange}{\strdflip{\strdlchange}}

\newcommand*{\strdjump}{\strdnone{\strdmid}}
\newcommand*{\strdljump}{\strdnone{\strdhleft}}
\newcommand*{\strdrjump}{\strdnone{\strdhright}}
\newcommand*{\strddup}{\strdnone{\strdminus}}


% Square strings
%

\newcommand*{\strdsqsubset}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2 StartCorner) at ($(#1 End)+(-\strdxunit,0)$) {};
    \node[strd coord] (#2) at ($(#1 End)+(-\strdxunit,-\strdyhalfunit)$) {};
    \node[strd coord] (#2 EndCorner) at ($(#1 End)+(-\strdxunit,-\strdyunit)$) {};
    \node[strd coord] (#2 End) at ($(#1 End)+(0,-\strdyunit)$) {};
    \draw[strd draw]{
        (#2 Start) -- (#2 StartCorner) -- (#2 EndCorner) -- (#2 End)
    };%
}
\newcommand*{\strdsqsupset}{\strdflip{\strdsqsubset}}

\newcommand*{\strdsquare}[2]{%
    \strdsqsubset{#1}{#2 Left}
    \strdsqsupset{#1}{#2 Right}
    \strdjump{#1}{#2}%
}


% Nodes
%

\tikzset{strd node/.style={font=\normalsize,very thin,solid,draw,fill=white,inner xsep=0.6pt,inner ysep=1.2pt}}
\tikzset{strd nodelabel/.style={font=\normalsize,inner sep=0pt}}
\tikzset{strd cellnode/.style={strd node,rectangle,minimum size=9pt}}
\tikzset{strd bijnode/.style={strd node,thin,rectangle,sharp corners,minimum size=9pt}}
\tikzset{strd isonode/.style={strd node,tape,tape bend height=2pt,minimum width=0pt,tape bend top=out and in,tape bend bottom=out and in}}
\tikzset{strd dotnode/.style={circle,draw=black,fill=black,minimum size=1.5pt,inner sep=0pt}}

% remove me; doesn't work well.
\newcommand*{\myvphantomd}[1]{%
    \vphantom{\operatorname{\vphantom{#1}}}%
}
\newcommand*{\myvphantom}[1]{}

\newcommand*{\strdasis}[1]{#1}

% remove me
\newcommand*{\strdsub}[2]{%
    \myvphantom{#2}_{#1}%
}
\newcommand*{\strdsuper}[2]{%
    \myvphantom{#2}^{#1}%
}

\newcommand*{\strdcellnode}[2]{%
    \strdonlayer{strd nodelayer}{
        \node[strd cellnode] (#1 Node) at (#1) {#2};
    }% 
}

\newcommand*{\strdbijnode}[2]{%
    \strdonlayer{strd nodelayer}{
        \node[strd bijnode] (#1 Node) at (#1) {#2};
    }%
}

\newcommand*{\strdisonode}[2]{%
    \strdonlayer{strd nodelayer}{
        \node[strd isonode] (#1 Node) at (#1) {#2};
    }% 
}

\newcommand*{\strddotnode}[1]{%
    \strdonlayer{strd nodelayer}{
        \node[strd dotnode] (#1 Node) at (#1) {};%
    }% 
}

\newcommand*{\strdimplicit}{\strdscopepathis{densely dotted}}


% Squares
%

\tikzset{strd bijsq/.style={solid,thin,sharp corners}}
\tikzset{strd mapsq/.style={rounded corners=2pt}}

\newcommand*{\strdlbijsq}[2]{%
    \strdonlayer{strd labellayer}{
        \strdscopepathis{strd bijsq}{\strdsqsubset{#1}{#2}}
    }%
}
\newcommand*{\strdrbijsq}[2]{%
    \strdonlayer{strd labellayer}{
        \strdscopepathis{strd bijsq}{\strdsqsupset{#1}{#2}}
    }%
}
\newcommand*{\strdbijsq}[2]{%
    \strdonlayer{strd labellayer}{
        \strdscopepathis{strd bijsq}{\strdsquare{#1}{#2}}
    }%
}
\newcommand*{\strdbijsqx}[5]{%
    \strdscale{#2}{#1}{\strdlbijsq}{#4}{#5 Left}
    \strdscale{#3}{#1}{\strdrbijsq}{#4}{#5 Right}
    \strdyscale{#1}{\strdjump}{#4}{#5}%
} 

\newcommand*{\strdlmapsq}[2]{%
    \strdonlayer{strd labellayer}{
        \strdscopepathis{strd mapsq}{\strdsqsubset{#1}{#2}}
    }%
}
\newcommand*{\strdrmapsq}[2]{%
    \strdonlayer{strd labellayer}{
        \strdscopepathis{strd mapsq}{\strdsqsupset{#1}{#2}}
    }%
}
\newcommand*{\strdmapsq}[2]{%
    \strdonlayer{strd labellayer}{
        \strdscopepathis{strd mapsq}{\strdsquare{#1}{#2}}
    }%
}
\newcommand*{\strdmapsqx}[5]{%
    \strdscale{#2}{#1}{\strdlmapsq}{#4}{#5 Left}
    \strdscale{#3}{#1}{\strdrmapsq}{#4}{#5 Right}
    \strdyscale{#1}{\strdjump}{#4}{#5}%
}


% Labels
%

\tikzset{strd sidelabel/.style={font=\scriptsize,inner sep=0.2pt,strd scripttextvaligned}}
\tikzset{strd familylabel/.style={font=\scriptsize,inner sep=0.4pt,inner ysep=0.8pt}}
\tikzset{strd endlabel/.style={font=\normalsize,inner sep=0.8pt,strd normaltextvaligned}}

\newcommand*{\strdsidelabel}[3]{%
    \strdonlayer{strd labellayer}{
        \node[strd sidelabel,left] at (#1) {#2};
        \node[strd sidelabel,right] at (#1) {\myvphantom{#2}#3};
    }%
}
\newcommand*{\strdleftlabel}[2]{\strdsidelabel{#1}{#2}{}}
\newcommand*{\strdrightlabel}[2]{\strdsidelabel{#1}{}{#2}}

\newcommand*{\strdfamilylabel}[3]{%
    \strdonlayer{strd labellayer}{
        \node[strd familylabel,above right] at (#1 EndCorner) {#2};
        \node[strd familylabel,below] at (#1 EndCorner) {\myvphantom{#2}#3};
    }%
}
\newcommand*{\strdunfamilylabel}[3]{%
    \strdonlayer{strd labellayer}{
        \node[strd familylabel,above left] at (#1 EndCorner) {#2};
        \node[strd familylabel,below] at (#1 EndCorner) {\myvphantom{#2}#3};
    }%
}

% remove me; sidelabels are enough
\newcommand*{\strdmaplabel}[3]{%
    \strdonlayer{strd labellayer}{
        \node[strd sidelabel,left] (#1 LeftLabel) at (#1) {#2};
        \node[strd sidelabel,right] (#1 RightLabel) at (#1) {\myvphantom{#2}#3};
    }%
}

\newcommand*{\strdsqlabel}[2]{%
    \strdonlayer{strd labellayer}{
        \node[strd familylabel,below left] at (#1 Right StartCorner) {#2};
    }%
}

\newcommand*{\strdlabelat}[3]{%
    \strdonlayer{strd labellayer}{
        \node[strd endlabel,#2] at (#1) {#3};
    }%
}

\newcommand*{\strdstartlabel}[2]{\strdlabelat{#1 Start}{above}{#2}}
\newcommand*{\strdendlabel}[2]{\strdlabelat{#1 End}{below}{#2}}


% Transformations
%

\newcommand*{\strdscope}[2]{%
    \begin{scope}[#1]
        #2
    \end{scope}%
}

\newcommand*{\strdscopeflip}{\strdscope{xscale=-1}}
\newcommand*{\strdscopeinv}{\strdscope{yscale=-1}}
\newcommand*{\strdscopexscale}[1]{\strdscope{xscale=#1}}
\newcommand*{\strdscopeyscale}[1]{\strdscope{yscale=#1}}
\newcommand*{\strdscopescale}[2]{\strdscope{xscale=#1,yscale=#2}}
\newcommand*{\strdscopenone}{\strdscope{every path/.style=strd none,every node/.style=strd none}}
\newcommand*{\strdscopenolabels}{\strdscope{every node/.style=strd none}}
\newcommand*{\strdscopepathis}[1]{\strdscope{every path/.style=#1}}
\newcommand*{\strdscopenodeis}[1]{\strdscope{every node/.append style=#1}}


% Composed strings
%

\newcommand*{\strdcap}[2]{%
    \strdleft{#1}{#2 Left}
    \strdright{#1}{#2 Right}
    \strdjump{#1}{#2}%
}

\newcommand*{\strdcup}[2]{%
    \strdxscale{2}{\strddup}{#1}{#2 Dup}
    \strdunleft{#2 Dup Left}{#2 Left}
    \strdunright{#2 Dup Right}{#2 Right}
    \strdjump{#1}{#2}%
}

\newcommand*{\strdbranch}[2]{%
    \strdmid{#1}{#2 Main}
    \strdleft{#2 Main}{#2 Left}
    \strdright{#2 Main}{#2 Right}
    \strdyscale{2}{\strdjump}{#1}{#2}
}

\newcommand*{\strdunbranch}[2]{%
    \strdxscale{2}{\strddup}{#1}{#2 Dup}
    \strdunleft{#2 Dup Left}{#2 Left}
    \strdunright{#2 Dup Right}{#2 Right}
    \strdmid{#2 Left}{#2 Main}
    \strdyscale{2}{\strdjump}{#1}{#2}
}

% rename me
\newcommand*{\strdparallel}[2]{%
    \strddup{#1}{#2 Dup}
    \strdmid{#2 Dup Left}{#2 Left}
    \strdmid{#2 Dup Right}{#2 Right}
    \strdjump{#1}{#2}%
}

\newcommand*{\strdcircle}[2]{%
    \strdsubset{#1}{#2 Left}
    \strdsupset{#1}{#2 Right}
    \strdjump{#1}{#2}%
}

% remove me
\newcommand*{\strdlchangez}[2]{%
    \strdunright{#1}{#2 Prev}
    \strdleft{#2 Prev}{#2}%
}
\newcommand*{\strdrchangez}{\strdflip{\strdlchangez}}

\newcommand*{\strdtwo}[3]{%
    \strduse{#1}{#2}{#3 1}
    \strduse{#1}{#3 1}{#3 2}
    \strdrange{#3 1 Start}{#3 1 End}{#3 2 End}{#3}
}


% White strings
%

\tikzset{strd edgenoise/.style={shorten >= -0.2pt,shorten <= -0.2pt}}
\tikzset{strd white/.style={draw=white,line width=3pt,strd edgenoise}}

\newcommand*{\strdwhite}[3]{%
    \strdonlayer{strd whitelayer}{
        \strdresetlinewidth
        \strdscope{strd white}{\strduse{#1}{#2}{#3}}
    }%
}

% Graded strings; order depends
%   tikz/double doesn't work with scopes.
%

\newcommand*{\strdgraded}[3]{%
    \strdonlayer{strd gradedlayer}{
        \strdresetlinewidth
        \strdscope{strd white}{\strduse{#1}{#2}{#3 Graded}}
        \strdscope{strd edgenoise}{\strduse{#1}{#2}{#3}}
    }%
}


% Roads
%   keep scaling away by '--'
%

\tikzset{strd roadcolor/.style={gray!18}}
\tikzset{strd roadbase/.style={line width=3.05pt}}
\tikzset{strd roadpave/.style={line width=2.65pt,strd edgenoise,strd roadcolor}}

\newcommand*{\strdroad}[3]{%
    \strdscope{strd roadbase}{\strduse{#1}{#2}{#3}}
    \strdonlayer{strd pavelayer}{
        \strdscope{strd roadpave}{\strduse{#1}{#2}{#3 Paved}}
    }%
}

% crossable road; order depends
\newcommand*{\strdroadx}[3]{%
    \strdscope{strd roadbase}{\strduse{#1}{#2}{#3}}
    \strdscope{strd roadpave}{\strduse{#1}{#2}{#3 Paved}}%
}

% slightly noisy around anti-aliasing
\newcommand*{\strddeadend}[1]{%
    \strdonlayer{strd whitelayer}{
        \draw[strd draw,white,line width=4pt,shorten >=-1pt] {
            ($(#1 End)+(0,10.16pt)$) -- (#1 End)
        };
        \draw[strd draw,strd roadbase]{
            ($(#1 End)+(0,10.16pt)$) -- ($(#1 End)+(0,10.36pt)$)
        };
    }%
}

\newcommand*{\strdroadlabel}[3]{%
    \strdonlayer{strd labellayer}{
        \node[strd sidelabel,left,xshift=-1.5pt] at (#1) {#2};
        \node[strd sidelabel,right,xshift=1.5pt] at (#1) {\myvphantom{#2}#3};
    }%
}

\newcommand*{\strdroadlaside}[2]{%
    \node[strd coord] (#2 Start) at ($(#1 End)+(-0.05,0)$) {};
    \node[strd coord] (#2) at (#2 Start) {};
    \node[strd coord] (#2 End) at (#2 Start) {};%
}
\newcommand*{\strdroadraside}{\strdflip{\strdroadlshift}}


% Command combinators
%

\newcommand*{\strdtofun}[4]{%
    #1{\strduse{#2}{#3}{#4}}%
}

\newcommand*{\strdflip}{\strdtofun{\strdscopeflip}}
\newcommand*{\strdinv}{\strdtofun{\strdscopeinv}}
\newcommand*{\strdnone}{\strdtofun{\strdscopenone}}
\newcommand*{\strdscale}[2]{\strdtofun{\strdscopescale{#1}{#2}}}
\newcommand*{\strdxscale}[1]{\strdtofun{\strdscopexscale{#1}}}
\newcommand*{\strdyscale}[1]{\strdtofun{\strdscopeyscale{#1}}}
\newcommand*{\strdxhalf}{\strdxscale{0.5}}
\newcommand*{\strdyhalf}{\strdyscale{0.5}}

\newcommand*{\strdlshift}[3]{%
    \strdljump{#2}{#3 Shift}
    \strduse{#1}{#3 Shift}{#3}%
}
\newcommand*{\strdrshift}[3]{\strdflip{\strdlshift{#1}}{#2}{#3}}

\newcommand*{\strdroadlshift}[3]{%
    \strdroadlaside{#2}{#3 Shift}
    \strduse{#1}{#3 Shift}{#3}%
}
\newcommand*{\strdroadrshift}[3]{\strdflip{\strdroadlshift{#1}}{#2}{#3}}


% Utilities
%

\newcommand*{\strdrlap}[1]{\mathrlap{\smash{\,#1}}}
\newcommand*{\strdfamilyarg}[1]{{\!\!\!#1}}

