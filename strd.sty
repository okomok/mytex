\ProvidesPackage{strd}

\usepackage{tikz,lambda}
\usepackage[active,tightpage]{preview}
\usetikzlibrary{shapes,calc,decorations.markings,backgrounds}


\newcommand*{\strduse}[1]{%
    \ifcsdef{strd\detokenize{#1}}{\csuse{strd#1}}{#1}%
}


% styles

\tikzset{strd celllabel/.style={font=\small,rounded rectangle,very thin,solid,rounded corners=0pt,rounded rectangle arc length=90,draw,fill=white,inner sep=1.2pt}}
\tikzset{strd linelabel/.style={font=\scriptsize,inner sep=0.2pt,strd textvaligned}}
\tikzset{strd endlabel/.style={font=\small,inner sep=1pt,strd textvaligned}}
\tikzset{strd valigned/.style={baseline={([yshift=-0.5ex]current bounding box.center)}}}
\tikzset{strd textvaligned/.style={text height=1.5ex,text depth=0.25ex}}
\tikzset{strd coord/.style={coordinate}}
\tikzset{strd dot/.style={circle,draw=black,fill=black,minimum size=1.5pt,inner sep=0pt}}
\tikzset{strd mathnodes/.style={execute at begin node=$,execute at end node=$}}
\tikzset{strd none/.style={opacity=0,text opacity=0,fill opacity=0}}
\tikzset{strd picture/.style={strd mathnodes,very thin,rounded corners=2pt}}
\tikzset{strd draw/.style={}}
\tikzset{-<-/.style={decoration={markings,mark=at position .5 with {\arrow{<}}},postaction={decorate}}}
\tikzset{nomorepostaction/.code={\let\tikz@postactions\pgfutil@empty}}


% layers
%   they reset surrounding line styles!

\pgfdeclarelayer{strd pavelayer}
\pgfdeclarelayer{strd piecelayer}
\pgfsetlayers{background,main,strd pavelayer,strd piecelayer}

\newcommand*{\strdonlayer}[2]{%
    \begin{pgfonlayer}{#1}
        #2
    \end{pgfonlayer}
    % temporary workaround
    \pgfsetlinewidth{0.2pt}%
}


% environmentals 

\newcommand*{\strd}[1]{%
    \begin{tikzpicture}[strd picture]
        \strddeclorigin
        #1;
    \end{tikzpicture}%
}

\def\strdin[#1]#2{%
    \Foldr{\strdinimpl}{#2}{\Listize[#1]}%
}
\newcommand*{\strdinimpl}[2]{%
    \begin{#1}
        \! % why needed?
        \strd{#2}
    \end{#1}%
}


% string constructors
%   A string 's' is a triple of nodes 's Start', 's' and 's End'.

\newcommand*{\strdrange}[4]{%
    \node[strd coord] (#1 Start) at (#2) {};
    \node[strd coord] (#1) at (#3) {};
    \node[strd coord] (#1 End) at (#4) {};%
}

\newcommand*{\strdcoord}[2]{%
    \node[strd coord] (#2 Start) at (#1) {};
    \node[strd coord] (#2) at (#1) {};
    \node[strd coord] (#2 End) at (#1) {};%
}

\newcommand*{\strddeclorigin}{\strdcoord{0,0}{strdorigin}}
\newcommand*{\strdorigin}{strdorigin}


% strings

\newcommand*{\strdempty}[2]{%
    \node[strd coord] (#2) at (#1 End) {};
    \node[strd coord] (#2 Start) at (#2) {};
    \node[strd coord] (#2 End) at (#2) {};%
}

\newcommand*{\strdleft}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2 Corner) at ($(#1 End)+(-0.5,-0.3)$) {};
    \node[strd coord] (#2) at ($(#1 End)+(-0.5,-0.4)$) {};
    \node[strd coord] (#2 End) at ($(#1 End)+(-0.5,-0.8)$) {};
    \draw[strd draw]{
        (#2 Start) parabola (#2 Corner) -- (#2 End)
    };%
}
\newcommand*{\strdright}{\strdflipped{left}}

\newcommand*{\strdmid}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2) at ($(#1 End)+(0,-0.4)$) {};
    \node[strd coord] (#2 End) at ($(#1 End)+(0,-0.8)$) {};
    \draw[strd draw]{
        (#2 Start) -- (#2 End)
    };%
}

\newcommand*{\strdunleft}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2) at ($(#1 End)+(0,-0.4)$) {};
    \node[strd coord] (#2 Corner) at ($(#1 End)+(0,-0.5)$) {};
    \node[strd coord] (#2 End) at ($(#1 End)+(0.5,-0.8)$) {};
    \draw[strd draw]{
        (#2 Start) -- (#2 Corner) parabola[bend at end] (#2 End)
    };%
}
\newcommand*{\strdunright}{\strdflipped{unleft}}

\newcommand*{\strdconnect}[3]{%
    \node[strd coord] (#3 Start) at (#1 Start) {};
    \node[strd coord] (#3) at (#2 Start) {};
    \node[strd coord] (#3 End) at (#2 End) {};%
}

\newcommand*{\strdhleft}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2) at ($(#1 End)+(-0.25,0)$) {};
    \node[strd coord] (#2 End) at ($(#1 End)+(-0.5,0)$) {};
    \draw[strd draw]{
        (#2 Start) -- (#2 End)
    };%
}
\newcommand*{\strdhright}{\strdflipped{hleft}}

\newcommand*{\strdminus}[2]{%
    \strdxscale{0.5}{
        \strdhleft{#1}{#2 Left}
        \strdempty{#1}{#2}
        \strdhright{#1}{#2 Right}
    }
}

\newcommand*{\strdsubset}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2 StartCorner) at ($(#1 End)+(-0.5,-0.3)$) {};
    \node[strd coord] (#2) at ($(#1 End)+(-0.5,-0.4)$) {};
    \node[strd coord] (#2 EndCorner) at ($(#1 End)+(-0.5,-0.5)$) {};
    \node[strd coord] (#2 End) at ($(#1 End)+(0,-0.8)$) {};
    \draw[strd draw]{
        (#2 Start) parabola (#2 StartCorner) -- (#2 EndCorner) parabola[bend at end] (#2 End)
    };%
}
\newcommand*{\strdsupset}{\strdflipped{subset}}

\newcommand*{\strdlint}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2 StartCorner) at ($(#1 End)+(-0.5,-0.3)$) {};
    \node[strd coord] (#2) at ($(#1 End)+(-0.5,-0.4)$) {};
    \node[strd coord] (#2 EndCorner) at ($(#1 End)+(-0.5,-0.5)$) {};
    \node[strd coord] (#2 End) at ($(#1 End)+(-1,-0.8)$) {};
    \draw[strd draw]{
        (#2 Start) parabola (#2 StartCorner) -- (#2 EndCorner) parabola[bend at end] (#2 End)
    };%
}
\newcommand*{\strdrint}{\strdflipped{lint}}

\newcommand*{\strdjump}{\strdnoned{mid}}
\newcommand*{\strdlshift}{\strdnoned{hleft}}
\newcommand*{\strdrshift}{\strdnoned{hright}}
\newcommand*{\strddup}{\strdnoned{minus}}


% square strings

\newcommand*{\strdsqsubset}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2 StartCorner) at ($(#1 End)+(-0.5,0)$) {};
    \node[strd coord] (#2) at ($(#1 End)+(-0.5,-0.4)$) {};
    \node[strd coord] (#2 EndCorner) at ($(#1 End)+(-0.5,-0.8)$) {};
    \node[strd coord] (#2 End) at ($(#1 End)+(0,-0.8)$) {};
    \draw[strd draw]{
        (#2 Start) -- (#2 StartCorner) -- (#2 EndCorner) -- (#2 End)
    };%
}
\newcommand*{\strdsqsupset}{\strdflipped{sqsubset}}

\newcommand*{\strdsquare}[2]{%
    \strdsqsubset{#1}{#2 Left}
    \strdsqsupset{#1}{#2 Right}
    \strdjump{#1}{#2}%
}


% labels

\newcommand*{\strddotlabel}[1]{%
    \node[strd dot] at (#1) {};%
}

\newcommand*{\strdcelllabel}[2]{%
    \strdonlayer{strd piecelayer}{
        \node[strd celllabel] at (#1) {#2};
    }% 
}

\newcommand*{\strdsidelabel}[3]{%
    \strdonlayer{strd piecelayer}{
        \node[strd linelabel,left] at (#1) {#2};
        \node[strd linelabel,right] at (#1) {#3};
    }%
}

\newcommand*{\strdstartlabel}[2]{%
    \strdonlayer{strd piecelayer}{
        \node[strd endlabel,above] at (#1 Start) {#2};
    }%
}

\newcommand*{\strdendlabel}[2]{%
    \strdonlayer{strd piecelayer}{
        \node[strd endlabel,below] at (#1 End) {#2};
    }%
}


% transformations

\newcommand*{\strdscope}[2]{%
    \begin{scope}[#1]
        #2
    \end{scope}%
}

\newcommand*{\strdflip}{\strdscope{xscale=-1}}
\newcommand*{\strdinv}{\strdscope{yscale=-1}}
\newcommand*{\strdxscale}[1]{\strdscope{xscale=#1}}
\newcommand*{\strdyscale}[1]{\strdscope{yscale=#1}}
\newcommand*{\strdscale}[2]{\strdscope{xscale=#1,yscale=#2}}
\newcommand*{\strdnone}{\strdscope{every path/.style=strd none,every node/.style=strd none}}
\newcommand*{\strdnolabels}{\strdscope{every node/.style=strd none}}
\newcommand*{\strdpathis}[1]{\strdscope{every path/.style=#1}}
\newcommand*{\strdnodeis}[1]{\strdscope{every node/.append style=#1}}


% category-theory specific 

\tikzset{strd bij/.style={solid,thin,rounded corners=0pt}}
\tikzset{strd bijlabel/.style={font=\small,rectangle,strd bij,draw,fill=white,inner sep=1.2pt}}
\tikzset{strd mapping/.style={rounded corners=2pt}}

\newcommand*{\strdimplicit}{\strdpathis{densely dotted}}

\newcommand*{\strdlbij}[2]{%
    \strdonlayer{strd piecelayer}{
        \strdpathis{strd bij}{\strdsqsubset{#1}{#2}}
    }%
}

\newcommand*{\strdrbij}[2]{%
    \strdonlayer{strd piecelayer}{
        \strdpathis{strd bij}{\strdsqsupset{#1}{#2}}
    }%
}

\newcommand*{\strdbij}[2]{%
    \strdonlayer{strd piecelayer}{
        \strdpathis{strd bij}{\strdsquare{#1}{#2}}
    }%
}

\newcommand*{\strdbijlabel}[2]{%
    \strdonlayer{strd piecelayer}{
        \node[strd bijlabel] at (#1) {#2};
    }%
}


% composed strings

\newcommand*{\strdcap}[2]{%
    \strdleft{#1}{#2 Left}
    \strdright{#1}{#2 Right}
    \strdjump{#1}{#2}%
}

\newcommand*{\strdbranch}[2]{%
    \strdmid{#1}{#2 Top}
    \strdcap{#2 Top}{#2}%
}

\newcommand*{\strdparallel}[2]{%
    \strddup{#1}{#2 Dup}
    \strdmid{#2 Dup Left}{#2 Left}
    \strdmid{#2 Dup Right}{#2 Right}
    \strdjump{#1}{#2}%
}

\newcommand*{\strdcircle}[2]{%
    \strdsubset{#1}{#2 Left}
    \strdsupset{#1}{#2 Right}
    \strdjump{#1}{#2}%
}


% roads
%   keep scaling away by '--'
\tikzset{strd roadcolor/.style={gray!18}}
\tikzset{strd roadbase/.style={line width=3.05pt}}
\tikzset{strd edgenoise/.style={shorten >= -0.2pt,shorten <= -0.2pt}}
\tikzset{strd roadpave/.style={line width=2.65pt,strd edgenoise,strd roadcolor}}

\newcommand*{\strdroad}[3]{%
    \strdscope{strd roadbase}{\strduse{#1}{#2}{#3}}
    \strdonlayer{strd pavelayer}{
        \strdscope{strd roadpave}{\strduse{#1}{#2}{#3 Paved}}
    }%
}

% order depends; crossable
\newcommand*{\strdroadx}[3]{%
    \strdscope{strd roadbase}{\strduse{#1}{#2}{#3}}
    \strdscope{strd roadpave}{\strduse{#1}{#2}{#3 Paved}}%
}

% slightly noisy
\newcommand*{\strddeadend}[1]{%
    \strdonlayer{strd piecelayer}{
        \draw[strd draw,white,line width=4pt,shorten >=-1pt] {
            ($(#1 End)+(0,5.68pt)$) -- (#1 End)
        };
        \draw[strd draw,strd roadbase]{
            ($(#1 End)+(0,5.68pt)$) -- ($(#1 End)+(0,5.88pt)$)
        };
    }%
}

\newcommand*{\strdroadlabel}[3]{%
    \strdonlayer{strd piecelayer}{
        \node[strd linelabel,left,xshift=-1.5pt] at (#1) {#2};
        \node[strd linelabel,right,xshift=1.5pt] at (#1) {#3};
    }%
}

\newcommand*{\strdroadlshift}[2]{%
    \node[strd coord] (#2 Start) at ($(#1 End)+(-0.05,0)$) {};
    \node[strd coord] (#2) at (#2 Start) {};
    \node[strd coord] (#2 End) at (#2 Start) {};%
}
\newcommand*{\strdroadrshift}{\strdflipped{roadlshift}}


% command combinators

\newcommand*{\strdtofun}[4]{%
    \strduse{#1}{\strduse{#2}{#3}{#4}}%
}

\newcommand*{\strdflipped}{\strdtofun{flip}}
\newcommand*{\strdnoned}{\strdtofun{none}}

\newcommand*{\strdlshifted}[3]{%
    \strdlshift{#2}{#2 Start}
    \strduse{#1}{#2 Start}{#3}%
}
\newcommand*{\strdrshifted}[3]{\strdflip{\strdlshifted{#1}{#2}{#3}}}

\newcommand*{\strdroadlshifted}[3]{%
    \strdroadlshift{#2}{#2 Start}
    \strduse{#1}{#2 Start}{#3}%
}
\newcommand*{\strdroadrshifted}[3]{\strdflip{\strdroadlshifted{#1}{#2}{#3}}}


% utilities

\newcommand*{\strdfamily}[2]{\left(#2\right)_{\!\!\!#1}}

