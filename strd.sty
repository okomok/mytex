\ProvidesPackage{strd}

\usepackage{amsmath,mathtools,etoolbox}
\usepackage{tikz}
\usepackage[active,tightpage]{preview}
\usetikzlibrary{backgrounds,shapes,positioning,fit,calc}

\pgfdeclarelayer{strdcelllabellayer}
\pgfsetlayers{background,main,strdcelllabellayer}


% styles

% no transparent color?
\tikzset{strd celllabel/.style={font=\small,rounded rectangle,rounded rectangle arc length=90 ,draw,fill=white,inner sep=1.2pt}}
\tikzset{strd linelabel/.style={font=\scriptsize,inner sep=0.2pt,strd textvaligned}}
\tikzset{strd endlabel/.style={font=\small,inner sep=1pt,strd textvaligned}}
\tikzset{strd valigned/.style={baseline={([yshift=-0.5ex]current bounding box.center)}}}
\tikzset{strd textvaligned/.style={text height=1.5ex,text depth=0.25ex}}
\tikzset{strd coord/.style={coordinate}}
\tikzset{strd dot/.style={circle,draw=black,fill=black,minimum size=1.5pt,inner sep=0pt}}
\tikzset{strd cornering/.style={rounded corners=2pt}}
\tikzset{strd mathnodes/.style={execute at begin node=$,execute at end node=$}}
\tikzset{strd none/.style={opacity=0,text opacity=0,fill opacity=0}}


% environmentals 

\newcommand{\strd}[1]{%
    \begin{tikzpicture}[strd mathnodes]
        \strddeclareorigin
        #1;
    \end{tikzpicture}%
}

\newcommand{\strdpreview}[1]{%
    \begin{preview}
        \begin{math}
            #1
        \end{math}
    \end{preview}%
}

\newcommand{\strdgathered}[1]{%
    \! % why needed?
    \begin{gathered}
        \strd{#1}
    \end{gathered}%
}


% string constructors
%   A string 's' is a triple of nodes 's Start', 's' and 's End'.

\newcommand{\strdrange}[4]{%
    \node[strd coord] (#1 Start) at (#2) {};
    \node[strd coord] (#1) at (#3) {};
    \node[strd coord] (#1 End) at (#4) {};%
}

\newcommand{\strdcoordat}[3]{%
    \node[strd coord] (#3 Start) at (#1,#2) {};
    \node[strd coord] (#3) at (#1,#2) {};
    \node[strd coord] (#3 End) at (#1,#2) {};%
}

\newcommand{\strdcoord}[2]{%
    \node[strd coord] (#2 Start) at (#1) {};
    \node[strd coord] (#2) at (#1) {};
    \node[strd coord] (#2 End) at (#1) {};%
}

\newcommand{\strddeclareorigin}{%
    \strdcoordat{0}{0}{strdorigin}%
}

\newcommand{\strdorigin}{strdorigin}


% string combinators

% golden ratio
\newcommand{\strdxunit}{0.5}
\newcommand{\strdyunit}{0.8}
\newcommand{\strdhalfxunit}{0.25}
\newcommand{\strdhalfyunit}{0.4}
\newcommand{\strdunitdiff}{0.3}
\newcommand{\strdunitrest}{0.2}

\newcommand{\strdempty}[2]{%
    \node[strd coord] (#2) at (#1 End) {};
    \node[strd coord] (#2 Start) at (#2) {};
    \node[strd coord] (#2 End) at (#2) {};%
}

\newcommand{\strdleft}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2 End) at ($(#2 Start)+(-\strdxunit,-\strdyunit)$) {};
    \node[strd coord] (#2 Corner) at ($(#2 End)+(0,\strdxunit)$) {};
    \node[strd coord] (#2) at ($(#2 Start)+(-\strdxunit,-\strdhalfyunit)$) {};
    \draw[strd cornering]{
        (#2 Start) parabola (#2 Corner) -- (#2 End)
    };%
}

\newcommand{\strdright}[2]{%
    \strdflip{ \strdleft{#1}{#2} }%
}

\newcommand{\strdsplitleft}[2]{%
    \strdxscale{0.5}{\strdshiftleft{#1}{#2 Start}}
    \strdleft{#2 Start}{#2}%
}

\newcommand{\strdsplitright}[2]{%
    \strdflip{\strdsplitleft{#1}{#2}}%
}

\newcommand{\strdunleft}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2 End) at ($(#2 Start)+(\strdxunit,-\strdyunit)$) {};
    \node[strd coord] (#2 Corner) at ($(#2 Start)+(0,-\strdxunit)$) {};
    \node[strd coord] (#2) at ($(#2 Start)+(0,-\strdhalfyunit)$) {};
    \draw[strd cornering]{
        (#2 Start) -- (#2 Corner) parabola[bend at end] (#2 End)
    };%
}

\newcommand{\strdunright}[2]{%
    \strdflip{ \strdunleft{#1}{#2} }%
}

\newcommand{\strdmid}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2) at ($(#1 End)+(0,-\strdhalfyunit)$) {};
    \node[strd coord] (#2 End) at ($(#1 End)+(0,-\strdyunit)$) {};
    \draw{
        (#2 Start) -- (#2 End)
    };%
}

\newcommand{\strdhalfmid}[2]{%
    \strdscale{1}{0.5}{\strdmid{#1}{#2}}%
}

\newcommand{\strdleftminus}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2) at ($(#1 End)+(-\strdhalfxunit,0)$) {};
    \node[strd coord] (#2 End) at ($(#1 End)+(-\strdxunit,0)$) {};
    \draw{
        (#2 Start) -- (#2 End)
    };%
}

\newcommand{\strdrightminus}[2]{%
    \strdflip{\strdleftminus{#1}{#2}}%
}

\newcommand{\strdsubset}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2 End) at ($(#2 Start)+(0,-\strdyunit)$) {};
    \node[strd coord] (#2 StartCorner) at ($(#2 End)+(-\strdxunit,\strdxunit)$) {};
    \node[strd coord] (#2 EndCorner) at ($(#2 Start)+(-\strdxunit,-\strdxunit)$) {};
    \node[strd coord] (#2) at ($(#2 Start)+(-\strdxunit,-\strdhalfyunit)$) {};
    \draw[strd cornering]{
        (#2 Start) parabola (#2 StartCorner) -- (#2 EndCorner) parabola[bend at end] (#2 End)
    };%
}

\newcommand{\strdsupset}[2]{%
    \strdflip{\strdsubset{#1}{#2}}%
}

\newcommand{\strdlbag}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2 StartCorner) at ($(#2 Start)+(-\strdxunit,-\strdunitdiff)$) {};
    \node[strd coord] (#2) at ($(#2 Start)+(-\strdxunit,-\strdhalfyunit)$) {};
    \node[strd coord] (#2 EndCorner) at ($(#2 StartCorner)+(0,-\strdunitrest)$) {};
    \node[strd coord] (#2 End) at ($(#2 EndCorner)+(-\strdxunit,-\strdunitdiff)$) {};
    \draw[strd cornering]{
        (#2 Start) parabola (#2 StartCorner) -- (#2 EndCorner) parabola[bend at end] (#2 End)
    };%
}

\newcommand{\strdrbag}[2]{\strdflip{\strdlbag{#1}{#2}}}

\newcommand{\strdjump}[2]{%
    \strdnone{ \strdmid{#1}{#2} }%
}

\newcommand{\strdshiftleft}[2]{%
    \strdnone{ \strdleftminus{#1}{#2} }%
}

\newcommand{\strdshiftright}[2]{%
    \strdnone{ \strdrightminus{#1}{#2} }%
}

\newcommand{\strdsqsubset}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2 StartCorner) at ($(#1 End)+(-\strdxunit,0)$) {};
    \node[strd coord] (#2) at ($(#1 End)+(-\strdxunit,-\strdhalfyunit)$) {};
    \node[strd coord] (#2 EndCorner) at ($(#1 End)+(-\strdxunit,-\strdyunit)$) {};
    \node[strd coord] (#2 End) at ($(#1 End)+(0,-\strdyunit)$) {};
    \draw{
        (#2 Start) -- (#2 StartCorner) -- (#2 EndCorner) -- (#2 End)
    };%
}

\newcommand{\strdsqsupset}[2]{%
    \strdflip{ \strdsqsubset{#1}{#2} }%
}

\newcommand{\strdsquare}[2]{%
    \strdsqsubset{#1}{#2 Left}
    \strdjump{#1}{#2}
    \strdsqsupset{#1}{#2 Right}%
}


% labels

\newcommand{\strddotlabel}[1]{%
    \node[strd dot] at (#1) {};%
}

\newcommand{\strdcelllabel}[2]{%
    \begin{pgfonlayer}{strdcelllabellayer}
        \node[strd celllabel] at (#1) {#2};
    \end{pgfonlayer}%
}

\newcommand{\strdsidelabel}[3]{%
    \node[strd linelabel,left] at (#1) {#2};
    \node[strd linelabel,right] at (#1) {#3};%
}

\newcommand{\strdlsbracket}{\raisebox{0.075em}{[}}
\newcommand{\strdrsbracket}{\raisebox{0.075em}{]}}

\newcommand{\strdihomlabel}[3]{%
    \node[strd linelabel,left] at (#1) {\strdlsbracket#2};
    \node[strd linelabel,right] at (#1) {#3\strdrsbracket};%
}

\newcommand{\strdstartlabel}[2]{%
    \node[strd endlabel,above] at (#1 Start) {#2};%
}

\newcommand{\strdendlabel}[2]{%
    \node[strd endlabel,below] at (#1 End) {#2};%
}


% transformations

\newcommand{\strdflip}[1]{%
    \begin{scope}[xscale=-1]
        #1;
    \end{scope}%
}

\newcommand{\strdreverse}[1]{%
    \begin{scope}[yscale=-1]
        #1;
    \end{scope}%
}

\newcommand{\strdxscale}[2]{%
    \begin{scope}[xscale=#1]
        #2;
    \end{scope}%
}

\newcommand{\strdyscale}[2]{%
    \begin{scope}[yscale=#1]
        #2;
    \end{scope}%
}

\newcommand{\strdscale}[3]{%
    \begin{scope}[xscale=#1,yscale=#2] 
        #3;
    \end{scope}%
}

\newcommand{\strdnone}[1]{%
    \begin{scope}[every path/.style=strd none,every node/.style=strd none] 
        #1;
    \end{scope}%
}

\newcommand{\strdnolabels}[1]{%
    \begin{scope}[every node/.style=strd none] 
        #1;
    \end{scope}%
}

\newcommand{\strdpathwith}[2]{%
    \begin{scope}[every path/.append style=#1]
        #2;
    \end{scope}%
}

\newcommand{\strdsolid}[1]{\strdpathwith{solid}{#1}}
\newcommand{\strddotted}[1]{\strdpathwith{dotted}{#1}}


% category-theoric strings

\tikzset{strd bijection/.style={rounded corners=0pt}}
\tikzset{strd mapping/.style={rounded corners=2pt}}

\newcommand{\strdbijection}[2]{%
    \strdpathwith{strd bijection}{
        \strdsquare{#1}{#2}
    }%
}

\newcommand{\strdmapping}[2]{%
    \strdpathwith{strd mapping}{
        \strdsquare{#1}{#2}
    }%
}


% composed strings

% remove me
\newcommand{\strdbranch}[2]{%
    \strdmid{#1}{#2 Branch}
    \strdleft{#2 Branch}{#2 Left}
    \strdright{#2 Branch}{#2 Right}
    \strdyscale{2}{ \strdjump{#1}{#2} }%
}

\newcommand{\strdparallel}[2]{%
    \strdjump{#1}{#2}
    \strdshiftleft{#1}{#2 Left}
    \strdmid{#2 Left}{#2 Left} % funny name-conflict
    \strdshiftright{#1}{#2 Right}
    \strdmid{#2 Right}{#2 Right}%
}


% command combinators

\newcommand{\strdsidelabeled}[4]{%
    \ifcsdef{strd#1}{\csuse{strd#1}{#2}{#3#4}}{}
    \strdsidelabel{#3#4}{#3}{#4}%
}

