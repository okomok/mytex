\ProvidesPackage{strd}

\usepackage{amsmath,mathtools}
\usepackage{tikz}
\usepackage[active,tightpage]{preview}
\usetikzlibrary{backgrounds,shapes,positioning,fit,calc}

\pgfdeclarelayer{twocell}
\pgfsetlayers{background,main,twocell}


\newcommand{\strd}[1]{%
    \begin{tikzpicture}[]
        \begin{scope}[auto,execute at begin node=$,execute at end node=$]
            \strddeclareorigin
            #1;
        \end{scope}
    \end{tikzpicture}%
}

\newcommand{\strdbg}[1]{%
    \begin{pgfonlayer}{background}
        #1;
    \end{pgfonlayer}%
}

\newcommand{\strdscope}[2]{%
    \begin{scope}[#1]
        #2
    \end{scope}%
}

\newcommand{\strdpreview}[1]{%
    \begin{preview}
        \begin{math}
            #1
        \end{math}
    \end{preview}%
}

\newcommand{\strdgathered}[1]{%
    \begin{gathered}
        \strd{#1}
    \end{gathered}%
}

\newcommand{\strdstrut}{%
    \strut%
}

% no transparent color?
\tikzset{strd 2cell/.style={font=\scriptsize,rounded corners,draw,fill=white,inner sep=2pt}}

\tikzset{strd coord/.style={coordinate}}
\tikzset{strd edgelabel/.style={font=\tiny,inner sep=0pt,strd textvaligned}}
\tikzset{strd endlabel/.style={font=\scriptsize,inner sep=1pt,strd textvaligned}}
\tikzset{strd valigned/.style={baseline={([yshift=-0.5ex]current bounding box.center)}}}
\tikzset{strd textvaligned/.style={text height=0.5em,text depth=0.1em}}
\tikzset{strd junc/.style={circle,draw=black,fill=black,minimum size=2pt,inner sep=0pt}}
\tikzset{strd cornering/.style={rounded corners=2pt}}


% edges

\newcommand{\strdcoord}[3]{%
    \node[strd coord] (#3 Start) at (#1,#2) {};
    \node[strd coord] (#3) at (#1,#2) {};
    \node[strd coord] (#3 End) at (#1,#2) {};%
}

\newcommand{\strddeclareorigin}{%
    \strdcoord{0}{0}{strdorigin}%
}

\newcommand{\strdorigin}{strdorigin}

\newcommand{\strdleft}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2 Corner) at ($(#1 End)+(-0.5,-0.3)$) {};
    \node[strd coord] (#2) at ($(#1 End)+(-0.5,-0.4)$) {};
    \node[strd coord] (#2 End) at ($(#1 End)+(-0.5,-0.7)$) {};
    \draw[strd cornering]{
        (#2 Start) -- (#2 Corner) -- (#2 End)
    };%
}

\newcommand{\strdunleft}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2) at ($(#1 End)+(0,-0.3)$) {};
    \node[strd coord] (#2 Corner) at ($(#1 End)+(0,-0.4)$) {};
    \node[strd coord] (#2 End) at ($(#1 End)+(0.5,-0.7)$) {};
    \draw[strd cornering]{
        (#2 Start) -- (#2 Corner) -- (#2 End)
    };%
}

\newcommand{\strdline}[2]{%
    \node[strd coord] (#2 Start) at (#1 End) {};
    \node[strd coord] (#2) at ($(#1 End)+(0,-0.35)$) {};
    \node[strd coord] (#2 End) at ($(#1 End)+(0,-0.7)$) {};
    \draw{
        (#2 Start) -- (#2) -- (#2 End)
    };%
}

\newcommand{\strdright}[2]{%
    \strddual{ \strdleft{#1}{#2} }%
}

\newcommand{\strdunright}[2]{%
    \strddual{ \strdunleft{#1}{#2} }%
}

\newcommand{\strdfit}[2]{%
    \strdbg{
        \node[strd 2cell,draw=none,fit=#1] (#2 fit) {};
    }%
}

\newcommand{\strdjunc}[2]{%
    \node[strd junc] (#2 Start) at (#1 End) {};
    \node[strd junc] (#2) at (#1 End) {};
    \node[strd junc] (#2 End) at (#1 End) {};%
}

\newcommand{\strdcell}[3]{%
    \begin{pgfonlayer}{twocell}
        \node[strd 2cell] (#2 Stard) at (#1 End) {#3};
        \node[strd 2cell] (#2) at (#1 End) {#3};
        \node[strd 2cell] (#2 End) at (#1 End) {#3};
    \end{pgfonlayer}%
}

\newcommand{\strdpend}[3]{%
    \node[strd coord] (#2 Res) at (#1) {}; 
    \node[strd 2cell] (#2) at ($(#1)+(0,-0.5)$) {#3};
    \draw{
        (#1) -- (#2) 
    };%
    \strdbg{
        \node[strd 2cell,draw=none,fit=(#2) (#2 Res)] (#2 fit) {};
    }%
}

\newcommand{\strdfun}[3]{%
    \node[strd edgelabel,#2] at (#1) {#3};%
}

\newcommand{\strdhomobj}[3]{%
    \node[strd edgelabel,left] at (#1) {#2};
    \node[strd edgelabel,right] at (#1) {#3};%
}

\newcommand{\strdstart}[2]{%
    \node[strd endlabel,above] at (#1 Start) {#2};%
}

\newcommand{\strdend}[2]{%
    \node[strd endlabel,below] at (#1 End) {#2};%
}

\newcommand{\strdmcatlabel}[3]{%
    \node[strd endlabel,#2] at (#1) {#3};%
}

\newcommand{\strdop}[1]{%
    \begin{scope}[yscale=-1]
        #1;
    \end{scope}%
}

\newcommand{\strddual}[1]{%
    \begin{scope}[xscale=-1]
        #1;
    \end{scope}%
}

\newcommand{\strdxscale}[2]{%
    \begin{scope}[xscale=#1]
        #2;
    \end{scope}%
}

\newcommand{\strdyscale}[2]{%
    \begin{scope}[yscale=#1]
        #2;
    \end{scope}%
}

\newcommand{\strdshift}[3]{%
    \begin{scope}[xshift=#1,yshift=#2] 
        #3;
    \end{scope}%
}

\newcommand\strddef[2]{%
    \expandafter\newcommand\csname #1\endcsname{#2}%
}
